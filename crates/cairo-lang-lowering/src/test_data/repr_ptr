//! > Test reference to struct member.

//! > test_runner_name
test_function_lowering(expect_diagnostics: false)

//! > function
fn foo(s: Point) {
    bar(&s.x);
    baz(&s.y);
}

//! > function_name
foo

//! > module_code
struct Point {
    x: u32,
    y: u32,
}
extern fn bar(x: &u32) nopanic;
extern fn baz(y: &u32) nopanic;

//! > crate_settings
edition = "2024_07"

[experimental_features]
repr_ptrs = true

//! > semantic_diagnostics

//! > lowering_diagnostics

//! > lowering_flat
Parameters: v0: test::Point
blk0 (root):
Statements:
  (v1: core::integer::u32, v2: core::integer::u32) <- struct_destructure(v0)
  (v3: core::integer::u32, v4: @core::integer::u32) <- snapshot(v1)
  (v5: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v4)
  () <- test::bar(v5)
  (v6: core::integer::u32, v7: @core::integer::u32) <- snapshot(v2)
  (v8: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v7)
  () <- test::baz(v8)
End:
  Return()

//! > ==========================================================================

//! > Test single, double and triple reference

//! > test_runner_name
test_function_lowering(expect_diagnostics: false)

//! > function
fn foo() {
    let x = 3;
    bar(&x, &&x, &&&x);
}

//! > function_name
foo

//! > module_code
extern fn bar(x: &u32, y: &&u32, z: &&&u32) nopanic;

//! > crate_settings
edition = "2024_07"

[experimental_features]
repr_ptrs = true

//! > semantic_diagnostics

//! > lowering_diagnostics

//! > lowering_flat
Parameters:
blk0 (root):
Statements:
  (v0: core::integer::u32) <- 3
  (v1: core::integer::u32, v2: @core::integer::u32) <- snapshot(v0)
  (v3: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v2)
  (v4: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v2)
  (v5: core::box::Box::<@core::integer::u32>, v6: @core::box::Box::<@core::integer::u32>) <- snapshot(v4)
  (v7: core::box::Box::<@core::box::Box::<@core::integer::u32>>) <- core::box::into_repr_ptr_wrapper::<core::box::Box::<@core::integer::u32>>(v6)
  (v8: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v2)
  (v9: core::box::Box::<@core::integer::u32>, v10: @core::box::Box::<@core::integer::u32>) <- snapshot(v8)
  (v11: core::box::Box::<@core::box::Box::<@core::integer::u32>>) <- core::box::into_repr_ptr_wrapper::<core::box::Box::<@core::integer::u32>>(v10)
  (v12: core::box::Box::<@core::box::Box::<@core::integer::u32>>, v13: @core::box::Box::<@core::box::Box::<@core::integer::u32>>) <- snapshot(v11)
  (v14: core::box::Box::<@core::box::Box::<@core::box::Box::<@core::integer::u32>>>) <- core::box::into_repr_ptr_wrapper::<core::box::Box::<@core::box::Box::<@core::integer::u32>>>(v13)
  () <- test::bar(v3, v7, v14)
End:
  Return()

//! > ==========================================================================

//! > Test multiple references to same variable.

//! > test_runner_name
test_function_lowering(expect_diagnostics: false)

//! > function
fn foo() {
    let mut x = 1;
    bar(&x);
    bar(&x);
}

//! > function_name
foo

//! > module_code
extern fn bar(x: &u32) nopanic;

//! > crate_settings
edition = "2024_07"

[experimental_features]
repr_ptrs = true

//! > semantic_diagnostics

//! > lowering_diagnostics

//! > lowering_flat
Parameters:
blk0 (root):
Statements:
  (v0: core::integer::u32) <- 1
  (v1: core::integer::u32, v2: @core::integer::u32) <- snapshot(v0)
  (v3: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v2)
  () <- test::bar(v3)
  (v4: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v2)
  () <- test::bar(v4)
End:
  Return()

//! > ==========================================================================

//! > Test reference snapshot is double snapshot.

//! > test_runner_name
test_function_lowering(expect_diagnostics: false)

//! > function
fn foo(x: @u32) {
    bar(&x)
}

//! > function_name
foo

//! > module_code
extern fn bar(x: &@u32) nopanic;

//! > crate_settings
edition = "2024_07"

[experimental_features]
repr_ptrs = true

//! > semantic_diagnostics

//! > lowering_diagnostics

//! > lowering_flat
Parameters: v0: @core::integer::u32
blk0 (root):
Statements:
  (v1: @core::integer::u32, v2: @@core::integer::u32) <- snapshot(v0)
  (v3: core::box::Box::<@@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<@core::integer::u32>(v2)
  () <- test::bar(v3)
End:
  Return()

//! > ==========================================================================

//! > Test reference in match expression.

//! > test_runner_name
test_function_lowering(expect_diagnostics: false)

//! > function
fn foo(opt: Option<u32>) {
    match opt {
        Option::Some(x) => bar(&x),
        Option::None => (),
    }
}

//! > function_name
foo

//! > module_code
extern fn bar(x: &u32) nopanic;

//! > crate_settings
edition = "2024_07"

[experimental_features]
repr_ptrs = true

//! > semantic_diagnostics

//! > lowering_diagnostics

//! > lowering_flat
Parameters: v0: core::option::Option::<core::integer::u32>
blk0 (root):
Statements:
End:
  Match(match_enum(v0) {
    Option::Some(v1) => blk1,
    Option::None(v2) => blk2,
  })

blk1:
Statements:
  (v3: core::integer::u32, v4: @core::integer::u32) <- snapshot(v1)
  (v5: core::box::Box::<@core::integer::u32>) <- core::box::into_repr_ptr_wrapper::<core::integer::u32>(v4)
  () <- test::bar(v5)
End:
  Return()

blk2:
Statements:
End:
  Return()
